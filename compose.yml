version: '3.8'

services:
  # Database
  postgres:
    image: postgres:17-alpine
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-digibooking}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
    ports: ["5433:5432"]
    volumes: [postgres-data:/var/lib/postgresql/data]
    networks: [internal]

  # Backend API
  backend:
    image: digi-booking-app_backend
    build: { context: ., dockerfile: ./Containerfile }
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILE:-local}
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/${POSTGRES_DB:-digibooking}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD:-password}
      MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE: health,info,metrics,prometheus
    ports: ["8080:8080"]
    networks: [internal]
    depends_on: [postgres]

  # Frontend
  frontend:
    image: digi-booking-app_frontend
    build: { context: ., dockerfile: ./frontend/Containerfile }
    ports: ["${FRONTEND_PORT:-3000}:3000"]
    networks: [internal]
    depends_on: [backend]

  # Monitoring Stack
  prometheus:
    image: prom/prometheus:latest
    ports: ["9090:9090"]
    volumes: [./prometheus.yml:/etc/prometheus/prometheus.yml]
    networks: [internal]
    command: [
      '--config.file=/etc/prometheus/prometheus.yml',
      '--storage.tsdb.path=/prometheus',
      '--web.enable-lifecycle'
    ]

  grafana:
    image: grafana/grafana:latest
    ports: ["3001:3000"]
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-admin}
    volumes: [grafana-data:/var/lib/grafana]
    networks: [internal]
    depends_on: [prometheus]

volumes:
  postgres-data:
  grafana-data:

networks:
  internal:
    driver: bridge